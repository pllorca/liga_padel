<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <title>Ranking Tenis Amigos</title>
</head>
<body class="bg-gray-50 text-gray-900">

    <nav class="bg-white shadow-sm p-4 sticky top-0 z-50">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <h1 class="font-bold text-xl text-indigo-600">游 Tenis Tour</h1>
            <button onclick="document.getElementById('modal').style.display='flex'" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-medium">A침adir Resultado</button>
        </div>
    </nav>

    <main class="max-w-4xl mx-auto p-4">
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden mb-8">
            <div class="p-4 border-b border-gray-50 bg-gray-50/50">
                <h2 class="font-bold text-gray-700">Clasificaci칩n General</h2>
            </div>
            <table class="w-full text-left">
                <thead class="text-xs text-gray-400 uppercase bg-gray-50">
                    <tr>
                        <th class="p-4">Jugador</th>
                        <th class="p-4">V/D (%)</th>
                        <th class="p-4">Sets (%)</th>
                        <th class="p-4">Juegos (%)</th>
                    </tr>
                </thead>
                <tbody id="tabla-body">
                    </tbody>
            </table>
        </div>

        <h2 class="font-bold text-gray-700 mb-4 text-lg">Historial de Partidos</h2>
        <div id="historial" class="grid gap-4"></div>
    </main>

    <div id="modal" class="fixed inset-0 bg-black/60 hidden items-center justify-center p-4 z-[100]">
        <div class="bg-white rounded-2xl p-6 max-w-sm w-full shadow-2xl">
            <h2 class="text-xl font-bold mb-4">Nuevo Partido</h2>
            <form id="formPartido" class="space-y-3">
                <input type="password" id="pass" placeholder="Contrase침a Admin" class="w-full p-2 border rounded-lg" required>
                <div class="grid grid-cols-2 gap-2">
                    <input type="text" id="j1" placeholder="Equipo 1 - Jug 1" class="p-2 border rounded-lg text-sm" required>
                    <input type="text" id="j2" placeholder="Equipo 1 - Jug 2" class="p-2 border rounded-lg text-sm" required>
                </div>
                <div class="grid grid-cols-2 gap-2 border-t pt-2">
                    <input type="text" id="j3" placeholder="Equipo 2 - Jug 1" class="p-2 border rounded-lg text-sm" required>
                    <input type="text" id="j4" placeholder="Equipo 2 - Jug 2" class="p-2 border rounded-lg text-sm" required>
                </div>
                <div class="flex gap-2">
                    <input type="number" id="s1e1" placeholder="S1 E1" class="w-1/4 p-2 border rounded text-center">
                    <input type="number" id="s1e2" placeholder="S1 E2" class="w-1/4 p-2 border rounded text-center">
                    <input type="number" id="s2e1" placeholder="S2 E1" class="w-1/4 p-2 border rounded text-center">
                    <input type="number" id="s2e2" placeholder="S2 E2" class="w-1/4 p-2 border rounded text-center">
                </div>
                <button type="submit" class="w-full bg-indigo-600 text-white p-3 rounded-xl font-bold mt-4">Guardar en Google Sheets</button>
                <button type="button" onclick="document.getElementById('modal').style.display='none'" class="w-full text-gray-400 text-sm">Cerrar</button>
            </form>
        </div>
    </div>

    <script>
       // 1. CONFIGURACI칍N: Pega aqu칤 tus URLs
const URL_CSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRo0ghUZzZls94FVc7xNyu5EhGSic6h0M98AGuzalUr7J9vgxDDlCC07oUXJso4tch8CtGzk4DkC876/pub?gid=0&single=true&output=csv'; 
const URL_SCRIPT = 'https://script.google.com/macros/s/AKfycbxvM4dVfNMp3hXS7DynHPzCrIsiICIT-CTQZQhW91fp3KGE0zlxTcSIdalFSTFXQ8yMKg/exec';

// 2. FUNCI칍N PARA CARGAR Y CALCULAR (Tu l칩gica actual mejorada)
async function cargarDatos() {
    try {
        const res = await fetch(URL_CSV);
        const texto = await res.text();
        const filas = texto.split('\n').slice(1);
        let stats = {};
        const historialDiv = document.getElementById('historial');
        historialDiv.innerHTML = ""; // Limpiar antes de cargar

        filas.forEach(fila => {
            const c = fila.split(',');
            if (c.length < 10) return;

            const jugadoresPartidos = [c[4].trim(), c[5].trim(), c[6].trim(), c[7].trim()];
            
            jugadoresPartidos.forEach(j => {
                if (!stats[j]) stats[j] = { victorias: 0, partidos: 0, setsG: 0, setsT: 0, juegosG: 0, juegosT: 0 };
            });

            const s1e1 = parseInt(c[8]) || 0, s1e2 = parseInt(c[9]) || 0;
            const s2e1 = parseInt(c[10]) || 0, s2e2 = parseInt(c[11]) || 0;
            const s3e1 = parseInt(c[12]) || 0, s3e2 = parseInt(c[13]) || 0;

            const setsE1 = (s1e1 > s1e2 ? 1 : 0) + (s2e1 > s2e2 ? 1 : 0) + (s3e1 > s3e2 ? 1 : 0);
            const setsE2 = (s1e2 > s1e1 ? 1 : 0) + (s2e2 > s2e1 ? 1 : 0) + (s3e2 > s3e1 ? 1 : 0);
            const ganoE1 = setsE1 > setsE2;

            const actualizar = (jugador, gano, sFavor, sContra, jFavor, jContra) => {
                stats[jugador].partidos++;
                if (gano) stats[jugador].victorias++;
                stats[jugador].setsG += sFavor;
                stats[jugador].setsT += (sFavor + sContra);
                stats[jugador].juegosG += jFavor;
                stats[jugador].juegosT += (jFavor + jContra);
            };

            const jE1 = s1e1 + s2e1 + s3e1;
            const jE2 = s1e2 + s2e2 + s3e2;

            [c[4].trim(), c[5].trim()].forEach(j => actualizar(j, ganoE1, setsE1, setsE2, jE1, jE2));
            [c[6].trim(), c[7].trim()].forEach(j => actualizar(j, !ganoE1, setsE2, setsE1, jE2, jE1));

            // Pintar Historial
            historialDiv.innerHTML += `
                <div class="bg-white p-4 rounded-xl border border-gray-100 flex justify-between items-center shadow-sm text-sm">
                    <div><span class="font-bold">${c[4]}-${c[5]}</span> vs <span class="text-gray-500">${c[6]}-${c[7]}</span></div>
                    <div class="font-mono bg-indigo-50 text-indigo-700 px-2 py-1 rounded">${s1e1}-${s1e2} / ${s2e1}-${s2e2} ${s3e1||s3e2 ? '/ '+s3e1+'-'+s3e2 : ''}</div>
                </div>`;
        });

        const ranking = Object.keys(stats).map(nombre => ({
            nombre,
            winRate: (stats[nombre].victorias / stats[nombre].partidos) * 100 || 0,
            setsRate: (stats[nombre].setsG / stats[nombre].setsT) * 100 || 0,
            juegosRate: (stats[nombre].juegosG / stats[nombre].juegosT) * 100 || 0
        })).sort((a, b) => b.winRate - a.winRate || b.setsRate - a.setsRate);

        const tabla = document.getElementById('tabla-body');
        tabla.innerHTML = "";
        ranking.forEach(jugador => {
            tabla.innerHTML += `
                <tr class="border-b">
                    <td class="p-4 font-bold text-indigo-900">${jugador.nombre}</td>
                    <td class="p-4 text-center">${jugador.winRate.toFixed(1)}%</td>
                    <td class="p-4 text-center text-gray-500 text-sm">${jugador.setsRate.toFixed(1)}%</td>
                    <td class="p-4 text-center text-gray-400 text-xs">${jugador.juegosRate.toFixed(1)}%</td>
                </tr>`;
        });
    } catch (e) { console.error("Error cargando datos:", e); }
}

// 3. FUNCI칍N PARA ENVIAR DATOS (El formulario del Admin)
document.getElementById('formPartido').onsubmit = async (e) => {
    e.preventDefault();
    const btn = e.target.querySelector('button[type="submit"]');
    const originalText = btn.innerText;
    btn.innerText = "Guardando...";
    btn.disabled = true;

    const datos = {
        password: document.getElementById('pass').value,
        j1: document.getElementById('j1').value,
        j2: document.getElementById('j2').value,
        j3: document.getElementById('j3').value,
        j4: document.getElementById('j4').value,
        s1e1: document.getElementById('s1e1').value,
        s1e2: document.getElementById('s1e2').value,
        s2e1: document.getElementById('s2e1').value,
        s2e2: document.getElementById('s2e2').value,
        temporada: "2024", // Puedes hacerlo din치mico
        fecha: new Date().toLocaleDateString()
    };

    try {
        await fetch(URL_SCRIPT, {
            method: 'POST',
            mode: 'no-cors', // Importante para evitar bloqueos de Google
            body: JSON.stringify(datos)
        });
        alert("춰Partido guardado! Los cambios pueden tardar unos minutos en aparecer.");
        document.getElementById('modal').style.display = 'none';
        e.target.reset();
        cargarDatos();
    } catch (err) {
        alert("Error al enviar. Revisa la URL del script.");
    } finally {
        btn.innerText = originalText;
        btn.disabled = false;
    }
};

cargarDatos();
    </script>
</body>

</html>
